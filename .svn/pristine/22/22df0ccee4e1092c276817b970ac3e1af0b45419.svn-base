@extends('layout.main')

@include('modals/add-app')

@section('content')


<div class="container-fluid">
    <div class="row">

        <div class="col-md-2">

            <div class="sidebar dashboard-sidebar">
                <a class="btn btn-primary" data-toggle="modal" data-target="#addAppModal" role="button">ADD APP</a>
            </div>

            <div class="sidebar dashboard-sidebar">
                <ul id="appList" class="nav nav-sidebar">
                    <?php
                    foreach($apps as $app)
                    {
                    ?>

                    <li><a id="<?php echo $app->appid; ?>" onclick="getAppDetails(this.id);"> <?php echo str_replace('\'', '', $app->name); ?> </a></li>

                    <?php
                    }
                    ?>
                </ul>
            </div>

            <div style="clear:both"></div>

        </div>

        <div class="col-md-10">

            <h1>Dashboard</h1>

            <div class="placeholders">

                <h3 class="page-header">Edit app</h3>
                <div id="appDetails" class="col-sm-12 placeholder"></div>

                <div style="clear:both"></div>

                <h3 class="page-header">Get recommendations</h3>
                <div id="appRecommendations" class="col-sm-12 placeholder"></div>

                <div style="clear:both"></div>

                <table id="recommendationList" class="table table-striped"></table>

            </div>

            <div style="clear:both"></div>

        </div>

    </div>
</div>

<script>

    window.addEventListener(
        "load",
        function()
        {
            $("#appList li:first-child a:first-child").trigger("click");
        },
        false
    );

    function renderForm(objFormData)
    {
        var elForm = document.createElement("form");
        elForm.setAttribute("id", "formFor"+objFormData.parent_id);
        elForm.setAttribute("class", "col-sm-9 form-horizontal");
        elForm.setAttribute("method", objFormData.method);
        elForm.setAttribute("action", objFormData.action);

        for(var objInput in objFormData.fields)
        {
            var elContainer = document.createElement("div");
            elContainer.setAttribute("class", "form-group");

            var elFormInputLabel = document.createElement("label");
            elFormInputLabel.setAttribute("class", "col-sm-3 control-label");
            elFormInputLabel.innerHTML = objFormData.fields[objInput].label;

            var elFormInputContainer = document.createElement("div");
            elFormInputContainer.setAttribute("class", "col-sm-6");

            if(objFormData.fields[objInput].type != "select")
            {
                var elFormInput = document.createElement("input");

                elFormInput.setAttribute("type", objFormData.fields[objInput].type);
                elFormInput.setAttribute("name", objFormData.fields[objInput].name);
                elFormInput.setAttribute("value", objFormData.fields[objInput].value);
                elFormInput.setAttribute("class", "form-control");
                elFormInput.setAttribute("required", "required");
                elFormInput.setAttribute("aria-required", "true");
            }
            else
            {
                var elFormInput = document.createElement("select");
                elFormInput.setAttribute("name", "select"+objFormData.fields[objInput].name);
                elFormInput.setAttribute("form", elForm.id);
                elFormInput.setAttribute("class", "form-control");

                $.get(
                    objFormData.fields[objInput].ajax_url,
                    function(mxResponse)
                    {
                        var objResponse = JSON.parse(mxResponse);

                        if(objResponse["response"])
                        {
                            for(var nIndex in objResponse["response"])
                            {
                                var elFormInputOption = document.createElement("option");
                                elFormInputOption.setAttribute("value", objResponse["response"][nIndex]);
                                elFormInputOption.innerHTML = objResponse["response"][nIndex];

                                elFormInput.appendChild(elFormInputOption);
                            }
                        }
                    }
                );
            }

            elFormInputContainer.appendChild(elFormInput);
            elContainer.appendChild(elFormInputLabel);
            elContainer.appendChild(elFormInputContainer);
            elForm.appendChild(elContainer);
        }

        var elSubmitButtonContainer = document.createElement("div");
        elSubmitButtonContainer.setAttribute("class", "col-sm-9 modal-footer");

        var elSubmitButton = document.createElement("input");

        if(!objFormData.method.length && !objFormData.action.length)
        {
            elSubmitButton.setAttribute("type", "button");

            if(objFormData.ajax_url.length)
            {
                elSubmitButton.addEventListener(
                    "click",
                    function()
                    {
                        var arrFormInputs = $("#"+objFormData.parent_id+" :input");

                        var strInitialURL = objFormData.ajax_url;
                        var bInvalidInput = false;

                        for(var elInput in arrFormInputs)
                        {
                            if(
                                arrFormInputs[elInput].type != "submit"
                                && arrFormInputs[elInput].type != "button"
                                && arrFormInputs[elInput].hasOwnProperty("value")
                            )
                            {
                                if(!arrFormInputs[elInput].value.length)
                                {
                                    bInvalidInput = true;
                                }
                                else
                                {
                                    objFormData.ajax_url = objFormData.ajax_url + "/" + arrFormInputs[elInput].value;
                                }
                            }
                        }

                        if(!bInvalidInput)
                        {
                            $.get(
                                objFormData.ajax_url,
                                function(mxResponse)
                                {
                                    clearForm(objFormData.ajax_result_container_id);

                                    var objResponse = JSON.parse(mxResponse);

                                    if(objResponse["response"])
                                    {
                                        var elRecommendationList = document.getElementById(objFormData.ajax_result_container_id);


                                        var elRecommendationListHead = document.createElement("thead");
                                        var elRecommendationListHeadRow = document.createElement("tr");

                                        var arrColumnNames = [
                                            "Product ID",
                                            "Product category",
                                            "Recommendation value"
                                        ];

                                        for(var nIndex in arrColumnNames)
                                        {
                                            var elRecommendationListHeadRowColumn = document.createElement("th");
                                            elRecommendationListHeadRowColumn.innerHTML = arrColumnNames[nIndex];

                                            elRecommendationListHeadRow.appendChild(elRecommendationListHeadRowColumn);
                                        }


                                        var elRecommendationListBody = document.createElement("tbody");

                                        for(var arrResponse in objResponse["response"])
                                        {
                                            var elRecommendationListBodyRow = document.createElement("tr");

                                            var elProductID = document.createElement("td");
                                            elProductID.innerHTML = objResponse["response"][arrResponse]["product_id"];

                                            var elProductCategory = document.createElement("td");
                                            elProductCategory.innerHTML = objResponse["response"][arrResponse]["category"];

                                            var elProductValue = document.createElement("td");
                                            elProductValue.innerHTML = objResponse["response"][arrResponse]["value"];

                                            elRecommendationListBodyRow.appendChild(elProductID);
                                            elRecommendationListBodyRow.appendChild(elProductCategory);
                                            elRecommendationListBodyRow.appendChild(elProductValue);

                                            elRecommendationListBody.appendChild(elRecommendationListBodyRow);
                                        }


                                        elRecommendationListHead.appendChild(elRecommendationListHeadRow);

                                        elRecommendationList.appendChild(elRecommendationListHead);
                                        elRecommendationList.appendChild(elRecommendationListBody);
                                    }

                                    objFormData.ajax_url = strInitialURL;
                                }
                            );
                        }
                        else
                        {
                            objFormData.ajax_url = strInitialURL;
                        }
                    },
                    false
                );
            }
        }
        else
        {
            elSubmitButton.setAttribute("type", "submit");
        }

        elSubmitButton.setAttribute("value", "Save");
        elSubmitButton.setAttribute("class", "btn btn-success");

        elSubmitButtonContainer.appendChild(elSubmitButton);
        elForm.appendChild(elSubmitButtonContainer);

        document.getElementById(objFormData.parent_id).appendChild(elForm);
    }

    function clearForm(mxParentID)
    {
        var elAppDetails = document.getElementById(mxParentID);
        while (elAppDetails.firstChild)
        {
            elAppDetails.removeChild(elAppDetails.firstChild);
        }

    }

    function getAppDetails(appID)
    {
        // Remove the active class from all <li> elements
        $("#appList > li").each(
            function()
            {
                $(this).removeClass();
            }
        );

        // Add the active class to the first <li> element
        document.getElementById(appID).parentNode.setAttribute("class", "active");


        $.get(
            "{{ URL::to('app-get') }}/"+appID,
            function(mxResult)
            {
                var objResult = JSON.parse(mxResult);
                if(objResult.length)
                {
                    // Remove previous rendered form
                    clearForm("appDetails");
                    clearForm("appRecommendations");
                    clearForm("recommendationList");

                    var objFormAppData = {};

                    objFormAppData.parent_id = "appDetails";
                    objFormAppData.method = "POST";
                    objFormAppData.action = "{{ URL::to('app-edit') }}/"+appID;

                    objFormAppData.fields = [];
                    objFormAppData.fields.push(
                        {
                            "label": "App name",
                            "type": "text",
                            "name": "name",
                            "value": objResult[0]["name"].replace(/['"]+/g, '')
                        }
                    );
                    objFormAppData.fields.push(
                        {
                            "label": "App data URL",
                            "type": "url",
                            "name": "data_url",
                            "value": objResult[0]["data_url"].replace(/['"]+/g, '')
                        }
                    );
                    objFormAppData.fields.push(
                        {
                            "label": "Rating type",
                            "type": "text",
                            "name": "rating_type",
                            "value": objResult[0]["rating_type"].replace(/['"]+/g, '')
                        }
                    );

                    renderForm(objFormAppData);


                    var objFormAppRecommendations = {};

                    objFormAppRecommendations.parent_id = "appRecommendations";
                    objFormAppRecommendations.method = "";
                    objFormAppRecommendations.action = "";
                    objFormAppRecommendations.ajax_url = "{{ URL::to('app-recommendation') }}/"+appID;
                    objFormAppRecommendations.ajax_result_container_id = "recommendationList";

                    objFormAppRecommendations.fields = [];
                    objFormAppRecommendations.fields.push(
                        {
                            "label": "User ID",
                            "type": "number",
                            "name": "user_id",
                            "value": 1
                        }
                    );
                    objFormAppRecommendations.fields.push(
                        {
                            "label": "Category",
                            "type": "select",
                            "name": "category",
                            "ajax_url": "{{ URL::to('app-categories') }}/"+appID,
                        }
                    );

                    renderForm(objFormAppRecommendations);
                }
            }
        );
    }

</script>

@stop